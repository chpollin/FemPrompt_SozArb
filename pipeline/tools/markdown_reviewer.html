<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Reviewer - Human-in-the-Loop Validation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: #16213e;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            border-bottom: 1px solid #0f3460;
        }

        .header h1 {
            font-size: 1.2rem;
            color: #e94560;
        }

        .header select, .header button {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #0f3460;
            background: #1a1a2e;
            color: #eee;
            cursor: pointer;
        }

        .header button {
            background: #e94560;
            border: none;
            font-weight: bold;
        }

        .header button:hover {
            background: #ff6b6b;
        }

        .header button.pass {
            background: #2ecc71;
        }

        .header button.warn {
            background: #f39c12;
        }

        .header button.fail {
            background: #e74c3c;
        }

        .file-info {
            flex: 1;
            text-align: center;
            font-size: 0.9rem;
            color: #888;
        }

        .file-info strong {
            color: #fff;
        }

        /* Main Container */
        .container {
            display: flex;
            height: calc(100vh - 60px);
        }

        /* Panels */
        .panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #0f3460;
        }

        .panel:last-child {
            border-right: none;
        }

        .panel-header {
            background: #16213e;
            padding: 8px 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #0f3460;
        }

        .panel-header .badge {
            background: #0f3460;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        /* PDF Panel */
        .pdf-panel .panel-content {
            background: #fff;
            padding: 0;
        }

        .pdf-panel iframe, .pdf-panel embed, .pdf-panel object {
            width: 100%;
            height: 100%;
            border: none;
        }

        .pdf-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: #f5f5f5;
            color: #666;
        }

        .pdf-placeholder svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            fill: #ccc;
        }

        /* Markdown Panel */
        .markdown-panel .panel-content {
            background: #1e1e2e;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Markdown Syntax Highlighting */
        .md-heading {
            color: #89b4fa;
            font-weight: bold;
        }

        .md-bold {
            color: #f9e2af;
            font-weight: bold;
        }

        .md-italic {
            color: #a6e3a1;
            font-style: italic;
        }

        .md-code {
            background: #313244;
            padding: 2px 4px;
            border-radius: 3px;
            color: #f38ba8;
        }

        .md-link {
            color: #89dceb;
            text-decoration: underline;
        }

        .md-list {
            color: #fab387;
        }

        .md-table {
            color: #cba6f7;
        }

        .md-image {
            color: #94e2d5;
            background: #1e3a4c;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .md-glyph {
            color: #f38ba8;
            background: #3b1d23;
            padding: 2px 6px;
            border-radius: 3px;
        }

        /* Rendered Panel */
        .rendered-panel .panel-content {
            background: #fff;
            color: #333;
            font-family: Georgia, serif;
            font-size: 1rem;
            line-height: 1.8;
        }

        .rendered-panel h1, .rendered-panel h2, .rendered-panel h3 {
            color: #1a1a2e;
            margin: 1em 0 0.5em;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .rendered-panel h1 { font-size: 1.8rem; border-bottom: 2px solid #e94560; padding-bottom: 0.3em; }
        .rendered-panel h2 { font-size: 1.4rem; border-bottom: 1px solid #ddd; padding-bottom: 0.2em; }
        .rendered-panel h3 { font-size: 1.2rem; }

        .rendered-panel table {
            border-collapse: collapse;
            margin: 1em 0;
            width: 100%;
        }

        .rendered-panel th, .rendered-panel td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .rendered-panel th {
            background: #f5f5f5;
        }

        .rendered-panel code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }

        .rendered-panel blockquote {
            border-left: 4px solid #e94560;
            padding-left: 1em;
            margin: 1em 0;
            color: #666;
        }

        /* Sync Indicator */
        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #16213e;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #0f3460;
            font-size: 0.85rem;
        }

        .sync-indicator.synced {
            border-color: #2ecc71;
        }

        /* Review Notes */
        .notes-panel {
            width: 300px;
            background: #16213e;
            border-left: 1px solid #0f3460;
            display: flex;
            flex-direction: column;
        }

        .notes-panel textarea {
            flex: 1;
            background: #1a1a2e;
            border: none;
            color: #eee;
            padding: 15px;
            font-family: inherit;
            font-size: 0.9rem;
            resize: none;
        }

        .notes-panel textarea::placeholder {
            color: #666;
        }

        /* Checklist */
        .checklist {
            padding: 15px;
            border-bottom: 1px solid #0f3460;
        }

        .checklist label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .checklist input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        /* Navigation */
        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-buttons button {
            padding: 8px 16px;
        }

        /* File List Sidebar */
        .file-list {
            width: 250px;
            background: #16213e;
            border-right: 1px solid #0f3460;
            display: flex;
            flex-direction: column;
        }

        .file-list-header {
            padding: 10px 15px;
            border-bottom: 1px solid #0f3460;
            font-weight: bold;
        }

        .file-list-content {
            flex: 1;
            overflow-y: auto;
        }

        .file-item {
            padding: 8px 15px;
            cursor: pointer;
            border-bottom: 1px solid #0f3460;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-item:hover {
            background: #1a1a2e;
        }

        .file-item.active {
            background: #0f3460;
        }

        .file-item .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
        }

        .file-item .status-dot.pass { background: #2ecc71; }
        .file-item .status-dot.warn { background: #f39c12; }
        .file-item .status-dot.fail { background: #e74c3c; }
        .file-item .status-dot.pending { background: #666; }

        /* Stats Bar */
        .stats-bar {
            padding: 10px 15px;
            background: #0f3460;
            font-size: 0.8rem;
            display: flex;
            gap: 15px;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* Drop Zone */
        .drop-zone {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(233, 69, 96, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .drop-zone.active {
            display: flex;
        }

        .drop-zone-content {
            text-align: center;
            color: #fff;
        }

        .drop-zone-content h2 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        /* Instructions */
        .instructions {
            padding: 20px;
            text-align: center;
            color: #888;
        }

        .instructions h2 {
            color: #e94560;
            margin-bottom: 15px;
        }

        .instructions ol {
            text-align: left;
            max-width: 500px;
            margin: 0 auto;
            line-height: 1.8;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Markdown Reviewer</h1>
        <div class="nav-buttons">
            <button onclick="prevFile()">← Prev</button>
            <button onclick="nextFile()">Next →</button>
        </div>
        <div class="file-info">
            <span id="currentFile">No file loaded</span>
            <span id="fileProgress"></span>
        </div>
        <div class="nav-buttons">
            <button class="pass" onclick="markAs('pass')">✓ PASS</button>
            <button class="warn" onclick="markAs('warn')">⚠ WARN</button>
            <button class="fail" onclick="markAs('fail')">✗ FAIL</button>
        </div>
        <button onclick="exportReview()">Export Review</button>
    </div>

    <div class="container">
        <!-- File List -->
        <div class="file-list">
            <div class="file-list-header">
                Documents
                <div class="stats-bar">
                    <span class="stat"><span class="dot" style="background:#2ecc71"></span><span id="passCount">0</span></span>
                    <span class="stat"><span class="dot" style="background:#f39c12"></span><span id="warnCount">0</span></span>
                    <span class="stat"><span class="dot" style="background:#e74c3c"></span><span id="failCount">0</span></span>
                    <span class="stat"><span class="dot" style="background:#666"></span><span id="pendingCount">0</span></span>
                </div>
            </div>
            <div class="file-list-content" id="fileListContent">
                <!-- Populated dynamically -->
            </div>
        </div>

        <!-- PDF Panel -->
        <div class="panel pdf-panel">
            <div class="panel-header">
                <span>PDF Original</span>
                <span class="badge" id="pdfPages">-</span>
            </div>
            <div class="panel-content" id="pdfContent">
                <div class="pdf-placeholder">
                    <svg viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>
                    <p>Load a PDF file to compare</p>
                </div>
            </div>
        </div>

        <!-- Markdown Source Panel -->
        <div class="panel markdown-panel">
            <div class="panel-header">
                <span>Markdown Source</span>
                <span class="badge" id="mdChars">-</span>
            </div>
            <div class="panel-content" id="markdownContent">
                <div class="instructions">
                    <h2>Human-in-the-Loop Validation</h2>
                    <ol>
                        <li>Drag & drop your <code>markdown/</code> and <code>pdfs/</code> folders here</li>
                        <li>Or select files using the folder picker</li>
                        <li>Compare PDF original with Markdown conversion</li>
                        <li>Mark each document as PASS, WARN, or FAIL</li>
                        <li>Export your review when done</li>
                    </ol>
                    <p style="margin-top: 20px;">
                        <input type="file" id="folderInput" webkitdirectory multiple style="display:none">
                        <button onclick="document.getElementById('folderInput').click()">Select Folder</button>
                    </p>
                </div>
            </div>
        </div>

        <!-- Rendered Panel -->
        <div class="panel rendered-panel">
            <div class="panel-header">
                <span>Rendered Preview</span>
                <span class="badge" id="mdWords">-</span>
            </div>
            <div class="panel-content" id="renderedContent">
                <!-- Rendered markdown appears here -->
            </div>
        </div>

        <!-- Notes Panel -->
        <div class="notes-panel">
            <div class="panel-header">Review Notes</div>
            <div class="checklist">
                <label><input type="checkbox" id="checkTitle"> Title correct</label>
                <label><input type="checkbox" id="checkAbstract"> Abstract complete</label>
                <label><input type="checkbox" id="checkStructure"> Structure preserved</label>
                <label><input type="checkbox" id="checkTables"> Tables intact</label>
                <label><input type="checkbox" id="checkNoArtifacts"> No major artifacts</label>
            </div>
            <textarea id="reviewNotes" placeholder="Add notes about this document..."></textarea>
        </div>
    </div>

    <!-- Drop Zone Overlay -->
    <div class="drop-zone" id="dropZone">
        <div class="drop-zone-content">
            <h2>Drop Files Here</h2>
            <p>Drop your markdown/ and pdfs/ folders</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // State
        let files = {
            markdown: {},  // filename -> content
            pdfs: {}       // filename -> blob URL
        };
        let fileList = [];
        let currentIndex = 0;
        let reviews = {};  // filename -> { status, notes, checklist }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupDragDrop();
            setupFolderInput();
            setupScrollSync();
            loadSavedReviews();
        });

        // Drag & Drop
        function setupDragDrop() {
            const dropZone = document.getElementById('dropZone');

            document.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('active');
            });

            document.addEventListener('dragleave', (e) => {
                if (e.target === dropZone) {
                    dropZone.classList.remove('active');
                }
            });

            document.addEventListener('drop', async (e) => {
                e.preventDefault();
                dropZone.classList.remove('active');

                const items = e.dataTransfer.items;
                for (const item of items) {
                    if (item.kind === 'file') {
                        const entry = item.webkitGetAsEntry();
                        if (entry.isDirectory) {
                            await processDirectory(entry);
                        }
                    }
                }

                buildFileList();
                if (fileList.length > 0) {
                    loadFile(0);
                }
            });
        }

        // Process directory
        async function processDirectory(dirEntry) {
            const reader = dirEntry.createReader();
            const entries = await new Promise((resolve) => {
                reader.readEntries(resolve);
            });

            for (const entry of entries) {
                if (entry.isFile) {
                    const file = await new Promise((resolve) => entry.file(resolve));
                    const path = entry.fullPath;

                    if (file.name.endsWith('.md')) {
                        const content = await file.text();
                        files.markdown[file.name] = content;
                    } else if (file.name.endsWith('.pdf')) {
                        files.pdfs[file.name] = URL.createObjectURL(file);
                    }
                } else if (entry.isDirectory) {
                    await processDirectory(entry);
                }
            }
        }

        // Folder input
        function setupFolderInput() {
            document.getElementById('folderInput').addEventListener('change', async (e) => {
                for (const file of e.target.files) {
                    if (file.name.endsWith('.md')) {
                        const content = await file.text();
                        files.markdown[file.name] = content;
                    } else if (file.name.endsWith('.pdf')) {
                        files.pdfs[file.name] = URL.createObjectURL(file);
                    }
                }

                buildFileList();
                if (fileList.length > 0) {
                    loadFile(0);
                }
            });
        }

        // Build file list
        function buildFileList() {
            fileList = Object.keys(files.markdown).sort();
            updateFileListUI();
            updateStats();
        }

        // Update file list UI
        function updateFileListUI() {
            const container = document.getElementById('fileListContent');
            container.innerHTML = '';

            fileList.forEach((filename, index) => {
                const div = document.createElement('div');
                div.className = 'file-item' + (index === currentIndex ? ' active' : '');

                const status = reviews[filename]?.status || 'pending';
                div.innerHTML = `
                    <span class="status-dot ${status}"></span>
                    <span>${filename.replace('.md', '').substring(0, 30)}...</span>
                `;
                div.onclick = () => loadFile(index);
                container.appendChild(div);
            });
        }

        // Load file
        function loadFile(index) {
            if (index < 0 || index >= fileList.length) return;

            // Save current review before switching
            if (fileList[currentIndex]) {
                saveCurrentReview();
            }

            currentIndex = index;
            const filename = fileList[index];

            // Update UI
            document.getElementById('currentFile').innerHTML = `<strong>${filename}</strong>`;
            document.getElementById('fileProgress').textContent = ` (${index + 1} / ${fileList.length})`;

            // Load markdown
            const mdContent = files.markdown[filename];
            displayMarkdown(mdContent);

            // Load PDF
            const pdfName = filename.replace('.md', '.pdf');
            displayPDF(files.pdfs[pdfName]);

            // Load review if exists
            loadReviewForFile(filename);

            // Update file list UI
            updateFileListUI();
        }

        // Display markdown
        function displayMarkdown(content) {
            // Syntax highlighted source
            const highlighted = highlightMarkdown(content);
            document.getElementById('markdownContent').innerHTML = highlighted;

            // Rendered preview
            document.getElementById('renderedContent').innerHTML = marked.parse(content);

            // Stats
            document.getElementById('mdChars').textContent = `${content.length.toLocaleString()} chars`;
            document.getElementById('mdWords').textContent = `${content.split(/\s+/).length.toLocaleString()} words`;
        }

        // Highlight markdown syntax
        function highlightMarkdown(content) {
            let html = escapeHtml(content);

            // Highlight GLYPH placeholders (problems)
            html = html.replace(/GLYPH&lt;\d+&gt;/g, '<span class="md-glyph">$&</span>');

            // Highlight image placeholders
            html = html.replace(/&lt;!-- image --&gt;/g, '<span class="md-image">$&</span>');

            // Highlight headings
            html = html.replace(/^(#{1,6}\s.+)$/gm, '<span class="md-heading">$1</span>');

            // Highlight tables
            html = html.replace(/^(\|.+\|)$/gm, '<span class="md-table">$1</span>');

            // Highlight lists
            html = html.replace(/^(\s*[-*+]\s.+)$/gm, '<span class="md-list">$1</span>');

            return html;
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Display PDF
        function displayPDF(url) {
            const container = document.getElementById('pdfContent');

            if (url) {
                container.innerHTML = `<embed src="${url}" type="application/pdf" width="100%" height="100%">`;
            } else {
                container.innerHTML = `
                    <div class="pdf-placeholder">
                        <svg viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>
                        <p>PDF not found</p>
                    </div>
                `;
            }
        }

        // Scroll sync
        function setupScrollSync() {
            const mdPanel = document.getElementById('markdownContent');
            const renderedPanel = document.getElementById('renderedContent');

            let syncing = false;

            mdPanel.addEventListener('scroll', () => {
                if (syncing) return;
                syncing = true;
                const ratio = mdPanel.scrollTop / (mdPanel.scrollHeight - mdPanel.clientHeight);
                renderedPanel.scrollTop = ratio * (renderedPanel.scrollHeight - renderedPanel.clientHeight);
                setTimeout(() => syncing = false, 50);
            });

            renderedPanel.addEventListener('scroll', () => {
                if (syncing) return;
                syncing = true;
                const ratio = renderedPanel.scrollTop / (renderedPanel.scrollHeight - renderedPanel.clientHeight);
                mdPanel.scrollTop = ratio * (mdPanel.scrollHeight - mdPanel.clientHeight);
                setTimeout(() => syncing = false, 50);
            });
        }

        // Navigation
        function prevFile() {
            loadFile(currentIndex - 1);
        }

        function nextFile() {
            loadFile(currentIndex + 1);
        }

        // Mark as
        function markAs(status) {
            const filename = fileList[currentIndex];
            if (!reviews[filename]) {
                reviews[filename] = {};
            }
            reviews[filename].status = status;
            saveCurrentReview();
            updateStats();
            updateFileListUI();

            // Auto-advance to next
            if (currentIndex < fileList.length - 1) {
                setTimeout(() => nextFile(), 300);
            }
        }

        // Save current review
        function saveCurrentReview() {
            const filename = fileList[currentIndex];
            if (!filename) return;

            if (!reviews[filename]) {
                reviews[filename] = {};
            }

            reviews[filename].notes = document.getElementById('reviewNotes').value;
            reviews[filename].checklist = {
                title: document.getElementById('checkTitle').checked,
                abstract: document.getElementById('checkAbstract').checked,
                structure: document.getElementById('checkStructure').checked,
                tables: document.getElementById('checkTables').checked,
                noArtifacts: document.getElementById('checkNoArtifacts').checked
            };

            // Save to localStorage
            localStorage.setItem('markdownReviews', JSON.stringify(reviews));
        }

        // Load review for file
        function loadReviewForFile(filename) {
            const review = reviews[filename] || {};

            document.getElementById('reviewNotes').value = review.notes || '';
            document.getElementById('checkTitle').checked = review.checklist?.title || false;
            document.getElementById('checkAbstract').checked = review.checklist?.abstract || false;
            document.getElementById('checkStructure').checked = review.checklist?.structure || false;
            document.getElementById('checkTables').checked = review.checklist?.tables || false;
            document.getElementById('checkNoArtifacts').checked = review.checklist?.noArtifacts || false;
        }

        // Load saved reviews
        function loadSavedReviews() {
            const saved = localStorage.getItem('markdownReviews');
            if (saved) {
                reviews = JSON.parse(saved);
            }
        }

        // Update stats
        function updateStats() {
            let pass = 0, warn = 0, fail = 0, pending = 0;

            fileList.forEach(filename => {
                const status = reviews[filename]?.status;
                if (status === 'pass') pass++;
                else if (status === 'warn') warn++;
                else if (status === 'fail') fail++;
                else pending++;
            });

            document.getElementById('passCount').textContent = pass;
            document.getElementById('warnCount').textContent = warn;
            document.getElementById('failCount').textContent = fail;
            document.getElementById('pendingCount').textContent = pending;
        }

        // Export review
        function exportReview() {
            const output = {
                timestamp: new Date().toISOString(),
                total: fileList.length,
                reviewed: Object.keys(reviews).length,
                summary: {
                    pass: 0,
                    warn: 0,
                    fail: 0
                },
                documents: []
            };

            fileList.forEach(filename => {
                const review = reviews[filename] || { status: 'pending' };

                if (review.status === 'pass') output.summary.pass++;
                else if (review.status === 'warn') output.summary.warn++;
                else if (review.status === 'fail') output.summary.fail++;

                output.documents.push({
                    filename,
                    status: review.status || 'pending',
                    notes: review.notes || '',
                    checklist: review.checklist || {}
                });
            });

            // Download as JSON
            const blob = new Blob([JSON.stringify(output, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `manual_review_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'TEXTAREA') return;

            switch(e.key) {
                case 'ArrowLeft':
                    prevFile();
                    break;
                case 'ArrowRight':
                    nextFile();
                    break;
                case '1':
                    markAs('pass');
                    break;
                case '2':
                    markAs('warn');
                    break;
                case '3':
                    markAs('fail');
                    break;
            }
        });
    </script>
</body>
</html>
